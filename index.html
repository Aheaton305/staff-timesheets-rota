<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staffing App</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-6 md:p-10">

    <!-- JavaScript for app logic -->
    <script>
        let allRotas = [];
        let allTimesheets = [];
        let currentHome = null;

        function showMessage(message) {
            const modal = document.getElementById('messageModal');
            const modalMessage = document.getElementById('modalMessage');
            modalMessage.textContent = message;
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 3000);
        }

        function attachListeners() {
            document.getElementById('addRotaForm').addEventListener('submit', handleAddRota);
            document.getElementById('submitTimesheetForm').addEventListener('submit', handleSubmitTimesheet);
            document.getElementById('editForm').addEventListener('submit', handleEditFormSubmit);
            document.getElementById('closeEditModal').addEventListener('click', () => {
                document.getElementById('editModal').style.display = 'none';
            });
            document.getElementById('filterDate').addEventListener('change', compareData);
            document.getElementById('addTestDataButton').addEventListener('click', addTestData);
            document.getElementById('homeSelect').addEventListener('change', (e) => {
                currentHome = e.target.value;
                if (currentHome) {
                    loadDataForHome();
                } else {
                    document.getElementById('rotaList').innerHTML = '<p class="text-gray-500">Please select a home.</p>';
                    document.getElementById('timesheetList').innerHTML = '<p class="text-gray-500">Please select a home.</p>';
                    document.getElementById('comparisonList').innerHTML = '<p class="text-gray-500">Please select a home.</p>';
                    document.getElementById('staffReportList').innerHTML = '<p class="text-gray-500">Please select a home.</p>';
                }
            });

            // Set initial state
            currentHome = document.getElementById('homeSelect').value;
            if (currentHome) {
                loadDataForHome();
            } else {
                document.getElementById('rotaList').innerHTML = '<p class="text-gray-500">Please select a home.</p>';
                document.getElementById('timesheetList').innerHTML = '<p class="text-gray-500">Please select a home.</p>';
                document.getElementById('comparisonList').innerHTML = '<p class="text-gray-500">Please select a home.</p>';
                document.getElementById('staffReportList').innerHTML = '<p class="text-gray-500">Please select a home.</p>';
            }
        }

        window.onload = attachListeners;

        function loadDataForHome() {
            // Filter in-memory data for the selected home
            const rotasForHome = allRotas.filter(r => r.home === currentHome);
            const timesheetsForHome = allTimesheets.filter(t => t.home === currentHome);
            
            displayRotas(rotasForHome);
            displayTimesheets(timesheetsForHome);
            compareData();
            generateStaffReport();
        }

        function handleAddRota(event) {
            event.preventDefault();
            const name = document.getElementById('rotaName').value;
            const category = document.getElementById('rotaCategory').value;
            const date = document.getElementById('rotaDate').value;
            const startTime = document.getElementById('rotaStartTime').value;
            const endTime = document.getElementById('rotaEndTime').value;
            const home = document.getElementById('homeSelect').value;

            if (!home || !name || !category || !date || !startTime || !endTime) {
                showMessage("All rota fields are required.");
                return;
            }

            const newRota = {
                id: Date.now().toString(), // Simple unique ID
                home,
                name,
                category,
                date,
                startTime,
                endTime,
            };
            allRotas.push(newRota);
            showMessage("Rota shift added successfully!");
            document.getElementById('addRotaForm').reset();
            loadDataForHome(); // Refresh the UI
        }

        function handleSubmitTimesheet(event) {
            event.preventDefault();
            const name = document.getElementById('timesheetName').value;
            const date = document.getElementById('timesheetDate').value;
            const startTime = document.getElementById('timesheetStartTime').value;
            const endTime = document.getElementById('timesheetEndTime').value;
            const home = document.getElementById('homeSelect').value;
            const hours = calculateHours(startTime, endTime);
            
            if (!home || !name || !date || !startTime || !endTime) {
                showMessage("All timesheet fields are required.");
                return;
            }

            if (hours <= 0) {
                showMessage("End time must be after start time.");
                return;
            }

            const newTimesheet = {
                id: Date.now().toString(), // Simple unique ID
                home,
                name,
                date,
                startTime,
                endTime,
                hours: parseFloat(hours.toFixed(2)),
            };
            
            allTimesheets.push(newTimesheet);
            showMessage("Timesheet submitted successfully!");
            document.getElementById('submitTimesheetForm').reset();
            loadDataForHome(); // Refresh the UI
        }
        
        // Helper function to calculate hours between two time strings
        function calculateHours(startTime, endTime) {
            const start = new Date(`1970/01/01 ${startTime}`);
            const end = new Date(`1970/01/01 ${endTime}`);
            if (end < start) {
                // Handles shifts that cross midnight
                end.setDate(end.getDate() + 1);
            }
            return (end - start) / (1000 * 60 * 60);
        }

        function displayRotas(rotas) {
            const rotaList = document.getElementById('rotaList');
            rotaList.innerHTML = '';
            if (rotas.length === 0) {
                rotaList.innerHTML = '<p class="text-gray-500">No rota shifts planned yet for this home.</p>';
            } else {
                rotas.forEach(rota => {
                    const li = document.createElement('li');
                    li.className = "p-4 bg-white rounded-lg shadow-sm flex items-center justify-between";
                    li.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-800">${rota.name}</p>
                            <p class="text-sm text-gray-600">${rota.date} - ${rota.category}</p>
                            <p class="text-xs text-gray-500">${rota.startTime} - ${rota.endTime}</p>
                        </div>
                        <button class="edit-btn p-2 bg-indigo-100 text-indigo-700 rounded-md hover:bg-indigo-200 transition duration-200" data-id="${rota.id}" data-type="rota">Edit</button>
                    `;
                    rotaList.appendChild(li);
                });
            }
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', handleEditClick);
            });
        }

        function displayTimesheets(timesheets) {
            const timesheetList = document.getElementById('timesheetList');
            timesheetList.innerHTML = '';
            if (timesheets.length === 0) {
                timesheetList.innerHTML = '<p class="text-gray-500">No timesheets submitted yet for this home.</p>';
            } else {
                timesheets.forEach(ts => {
                    const li = document.createElement('li');
                    li.className = "p-4 bg-white rounded-lg shadow-sm flex items-center justify-between";
                    li.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-800">${ts.name}</p>
                            <p class="text-sm text-gray-600">${ts.date}</p>
                            <p class="text-xs text-gray-500">${ts.startTime} - ${ts.endTime} (${ts.hours} hours)</p>
                        </div>
                        <button class="edit-btn p-2 bg-emerald-100 text-emerald-700 rounded-md hover:bg-emerald-200 transition duration-200" data-id="${ts.id}" data-type="timesheet">Edit</button>
                    `;
                    timesheetList.appendChild(li);
                });
            }
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', handleEditClick);
            });
        }
        
        let editingDocId = null;
        let editingDocType = null;

        function handleEditClick(event) {
            const button = event.target;
            editingDocId = button.getAttribute('data-id');
            editingDocType = button.getAttribute('data-type');
            
            let data;
            if (editingDocType === 'rota') {
                data = allRotas.find(r => r.id === editingDocId);
            } else {
                data = allTimesheets.find(t => t.id === editingDocId);
            }

            if (data) {
                document.getElementById('editModal').style.display = 'flex';
                document.getElementById('editName').value = data.name;
                document.getElementById('editDate').value = data.date;
                document.getElementById('editStartTime').value = data.startTime;
                document.getElementById('editEndTime').value = data.endTime;
                document.getElementById('editFormTitle').textContent = `Edit ${editingDocType === 'rota' ? 'Rota' : 'Timesheet'} Entry`;
                
                // Show/hide category field based on type
                const editCategoryContainer = document.getElementById('editCategoryContainer');
                if (editingDocType === 'rota') {
                    editCategoryContainer.classList.remove('hidden');
                    document.getElementById('editCategory').value = data.category || '';
                } else {
                    editCategoryContainer.classList.add('hidden');
                }
            }
        }

        function handleEditFormSubmit(event) {
            event.preventDefault();
            const name = document.getElementById('editName').value;
            const date = document.getElementById('editDate').value;
            const startTime = document.getElementById('editStartTime').value;
            const endTime = document.getElementById('editEndTime').value;

            if (!name || !date || !startTime || !endTime) {
                showMessage("All fields are required.");
                return;
            }
            
            let docToUpdate;
            if (editingDocType === 'rota') {
                docToUpdate = allRotas.find(r => r.id === editingDocId);
            } else {
                docToUpdate = allTimesheets.find(t => t.id === editingDocId);
            }

            if (docToUpdate) {
                docToUpdate.name = name;
                docToUpdate.date = date;
                docToUpdate.startTime = startTime;
                docToUpdate.endTime = endTime;

                if (editingDocType === 'rota') {
                    docToUpdate.category = document.getElementById('editCategory').value;
                } else {
                    const hours = calculateHours(startTime, endTime);
                    if (hours <= 0) {
                        showMessage("End time must be after start time.");
                        return;
                    }
                    docToUpdate.hours = hours;
                }
                showMessage("Entry updated successfully!");
                document.getElementById('editModal').style.display = 'none';
                loadDataForHome(); // Refresh the UI
            } else {
                showMessage("Error updating entry. Please try again.");
            }
        }

        function compareData() {
            const filterDate = document.getElementById('filterDate').value;
            
            const rotasForHome = allRotas.filter(r => r.home === currentHome);
            const timesheetsForHome = allTimesheets.filter(t => t.home === currentHome);
            
            let rotasToCompare = rotasForHome;
            let timesheetsToCompare = timesheetsForHome;

            if (filterDate) {
                rotasToCompare = rotasForHome.filter(r => r.date === filterDate);
                timesheetsToCompare = timesheetsForHome.filter(t => t.date === filterDate);
            }

            const comparisonList = document.getElementById('comparisonList');
            comparisonList.innerHTML = '';
            const comparisonResults = [];

            timesheetsToCompare.forEach(ts => {
                const matchingRota = rotasToCompare.find(rota => rota.name === ts.name && rota.date === ts.date);
                const plannedHours = matchingRota ? calculateHours(matchingRota.startTime, matchingRota.endTime) : 0;
                
                let status = 'Match';
                let message = 'Timesheet hours match rota.';
                if (!matchingRota) {
                    status = 'No Rota';
                    message = 'No rota found for this timesheet.';
                } else if (ts.hours !== plannedHours) {
                    status = 'Discrepancy';
                    message = `Planned: ${plannedHours} hours, Recorded: ${ts.hours} hours.`;
                }

                comparisonResults.push({
                    name: ts.name,
                    date: ts.date,
                    status,
                    message,
                });
            });

            if (comparisonResults.length === 0) {
                 comparisonList.innerHTML = '<p class="text-gray-500">No data to compare.</p>';
            } else {
                 comparisonResults.forEach(result => {
                    let bgColor = '';
                    if (result.status === 'Match') bgColor = 'bg-green-100';
                    if (result.status === 'Discrepancy') bgColor = 'bg-red-100';
                    if (result.status === 'No Rota') bgColor = 'bg-yellow-100';

                    const li = document.createElement('li');
                    li.className = `p-4 rounded-lg shadow-sm flex items-center justify-between ${bgColor}`;
                    li.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-800">${result.name} - ${result.date}</p>
                            <p class="text-sm text-gray-600">${result.message}</p>
                        </div>
                        <span class="text-xs font-bold px-3 py-1 rounded-full ${result.status === 'Match' ? 'bg-green-500 text-white' : result.status === 'Discrepancy' ? 'bg-red-500 text-white' : 'bg-yellow-500 text-gray-800'}">${result.status}</span>
                    `;
                    comparisonList.appendChild(li);
                });
            }
        }

        // New function to generate staff reports
        function generateStaffReport() {
            const staffHours = {};
            allTimesheets.filter(t => t.home === currentHome).forEach(ts => {
                staffHours[ts.name] = (staffHours[ts.name] || 0) + ts.hours;
            });

            const reportList = document.getElementById('staffReportList');
            reportList.innerHTML = '';

            const sortedStaff = Object.keys(staffHours).sort((a, b) => staffHours[b] - staffHours[a]);

            if (sortedStaff.length === 0) {
                reportList.innerHTML = '<p class="text-gray-500">No timesheets submitted for a report.</p>';
            } else {
                sortedStaff.forEach(name => {
                    const li = document.createElement('li');
                    li.className = "p-4 bg-white rounded-lg shadow-sm flex items-center justify-between";
                    li.innerHTML = `
                        <p class="font-semibold text-gray-800">${name}</p>
                        <span class="text-sm text-gray-600">${staffHours[name]} hours</span>
                    `;
                    reportList.appendChild(li);
                });
            }
        }
        
        function addTestData() {
            allRotas = [
                { id: '1', home: 'Happy Home', name: 'John Doe', category: 'carer day', date: '2025-09-17', startTime: '08:00', endTime: '16:00' },
                { id: '2', home: 'Happy Home', name: 'Jane Smith', category: 'nurse day', date: '2025-09-17', startTime: '08:00', endTime: '16:00' },
                { id: '3', home: 'Happy Home', name: 'John Doe', category: 'carer day', date: '2025-09-18', startTime: '08:00', endTime: '16:00' },
                { id: '4', home: 'Serene Care', name: 'Jane Smith', category: 'nurse nights', date: '2025-09-17', startTime: '20:00', endTime: '04:00' },
                { id: '5', home: 'Serene Care', name: 'Mark Wilson', category: 'carer nights', date: '2025-09-18', startTime: '20:00', endTime: '04:00' },
            ];

            allTimesheets = [
                { id: '101', home: 'Happy Home', name: 'John Doe', date: '2025-09-17', startTime: '08:00', endTime: '16:00', hours: 8 },
                { id: '102', home: 'Happy Home', name: 'Jane Smith', date: '2025-09-17', startTime: '08:00', endTime: '16:30', hours: 8.5 },
                { id: '103', home: 'Happy Home', name: 'John Doe', date: '2025-09-18', startTime: '08:00', endTime: '15:30', hours: 7.5 },
                { id: '104', home: 'Serene Care', name: 'Peter Jones', date: '2025-09-18', startTime: '09:00', endTime: '17:00', hours: 8 },
            ];
            
            showMessage("Test data added successfully!");
            loadDataForHome(); // Refresh the UI
        }
    </script>

    <!-- Main Content Grid -->
    <div id="mainContent" class="max-w-7xl mx-auto space-y-8">
        <header class="text-center flex flex-col md:flex-row justify-between items-center mb-6 space-y-4 md:space-y-0">
            <h1 class="text-4xl font-bold text-gray-900">Staffing App</h1>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- Left Panel: Forms -->
            <div class="bg-white p-6 rounded-xl shadow-lg space-y-6">

                <!-- Home Selector -->
                <section>
                    <label for="homeSelect" class="block text-sm font-medium text-gray-700">Select a Home</label>
                    <select id="homeSelect" required
                            class="mt-1 block w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 transition duration-200">
                         <option value="" disabled selected>Select a Home</option>
                         <option value="Happy Home">Happy Home</option>
                         <option value="Serene Care">Serene Care</option>
                    </select>
                </section>
                
                <hr class="border-gray-200">

                <!-- Add Rota Form -->
                <section>
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Add Rota Shift</h2>
                    <form id="addRotaForm" class="space-y-4">
                        <input type="text" id="rotaName" placeholder="Staff Name" required
                               class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 transition duration-200">
                        <select id="rotaCategory" required
                                class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 transition duration-200">
                             <option value="" disabled selected>Select a Category</option>
                             <option value="carer day">Carer Day</option>
                             <option value="carer nights">Carer Nights</option>
                             <option value="nurse day">Nurse Day</option>
                             <option value="nurse nights">Nurse Nights</option>
                             <option value="team leader day">Team Leader Day</option>
                             <option value="team leader nights">Team Leader Nights</option>
                        </select>
                        <input type="date" id="rotaDate" required
                               class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 transition duration-200">
                        <div class="flex gap-4">
                            <input type="time" id="rotaStartTime" required
                                   class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 transition duration-200">
                            <input type="time" id="rotaEndTime" required
                                   class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 transition duration-200">
                        </div>
                        <button type="submit"
                                class="w-full p-3 bg-indigo-600 text-white font-semibold rounded-md shadow-md hover:bg-indigo-700 transition duration-200">
                            Add Rota
                        </button>
                    </form>
                </section>

                <hr class="border-gray-200">

                <!-- Submit Timesheet Form -->
                <section>
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Submit Timesheet</h2>
                    <form id="submitTimesheetForm" class="space-y-4">
                        <input type="text" id="timesheetName" placeholder="Staff Name" required
                               class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 transition duration-200">
                        <input type="date" id="timesheetDate" required
                               class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 transition duration-200">
                        <div class="flex gap-4">
                            <input type="time" id="timesheetStartTime" required
                                   class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 transition duration-200">
                            <input type="time" id="timesheetEndTime" required
                                   class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 transition duration-200">
                        </div>
                        <button type="submit"
                                class="w-full p-3 bg-emerald-600 text-white font-semibold rounded-md shadow-md hover:bg-emerald-700 transition duration-200">
                            Submit Timesheet
                        </button>
                    </form>
                </section>
                
                <hr class="border-gray-200">
                
                <section>
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Populate with Test Data</h2>
                    <p class="text-gray-600 mb-4">Click below to add sample rota and timesheet entries.</p>
                    <button id="addTestDataButton"
                            class="w-full p-3 bg-gray-500 text-white font-semibold rounded-md shadow-md hover:bg-gray-600 transition duration-200">
                        Add Test Data
                    </button>
                </section>
            </div>

            <!-- Right Panel: Data Display -->
            <div class="bg-white p-6 rounded-xl shadow-lg space-y-6">
                <!-- Rota Display Section -->
                <section>
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Current Rota</h2>
                    <ul id="rotaList" class="space-y-2">
                        <!-- Rota items will be populated by JavaScript -->
                    </ul>
                </section>

                <hr class="border-gray-200">

                <!-- Timesheets Display Section -->
                <section>
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Submitted Timesheets</h2>
                    <ul id="timesheetList" class="space-y-2">
                        <!-- Timesheet items will be populated by JavaScript -->
                    </ul>
                </section>
            </div>
        </main>

        <!-- Comparison Section -->
        <section class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Comparison Report</h2>
            <input type="date" id="filterDate" 
                   class="mb-4 w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 transition duration-200">
            <ul id="comparisonList" class="space-y-4">
                 <!-- Comparison results will be populated by JavaScript -->
            </ul>
        </section>
        
        <hr class="border-gray-200">

        <!-- Staff Report Section -->
        <section class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Staff Hours Report</h2>
            <ul id="staffReportList" class="space-y-2">
                <!-- Staff report will be populated by JavaScript -->
            </ul>
        </section>

    </div>

    <!-- Custom Modal for messages -->
    <div id="messageModal" class="modal">
        <div class="bg-white p-6 rounded-xl shadow-lg max-w-sm w-full text-center">
            <p id="modalMessage" class="font-semibold text-gray-800"></p>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="bg-white p-6 rounded-xl shadow-lg max-w-lg w-full">
            <h2 id="editFormTitle" class="text-2xl font-semibold text-gray-800 mb-4">Edit Entry</h2>
            <form id="editForm" class="space-y-4">
                <input type="text" id="editName" placeholder="Name" required
                       class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 transition duration-200">
                <div id="editCategoryContainer" class="hidden">
                    <select id="editCategory" required
                            class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 transition duration-200">
                         <option value="" disabled selected>Select a Category</option>
                         <option value="carer day">Carer Day</option>
                         <option value="carer nights">Carer Nights</option>
                         <option value="nurse day">Nurse Day</option>
                         <option value="nurse nights">Nurse Nights</option>
                         <option value="team leader day">Team Leader Day</option>
                         <option value="team leader nights">Team Leader Nights</option>
                    </select>
                </div>
                <input type="date" id="editDate" required
                       class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 transition duration-200">
                <div class="flex gap-4">
                    <input type="time" id="editStartTime" required
                           class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 transition duration-200">
                    <input type="time" id="editEndTime" required
                           class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 transition duration-200">
                </div>
                <div class="flex gap-4">
                    <button type="submit"
                            class="w-full p-3 bg-indigo-600 text-white font-semibold rounded-md shadow-md hover:bg-indigo-700 transition duration-200">
                        Save Changes
                    </button>
                    <button type="button" id="closeEditModal"
                            class="w-full p-3 bg-gray-300 text-gray-800 font-semibold rounded-md shadow-md hover:bg-gray-400 transition duration-200">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

</body>
</html>
